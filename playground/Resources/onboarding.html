<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Onboarding</title>

    <style>
      :root {
        /* iOS-friendly system palette */
        --bg0: #0b0c10;
        --bg1: #0f1220;
        --card: #121527cc;
        --cardSolid: #14182c;
        --text: #f6f7fb;
        --muted: #a9afbf;
        --muted2: #7c8396;
        --stroke: #252a3d;
        --stroke2: #2f3550;
        --shadow: 0 16px 44px rgba(0, 0, 0, 0.4);

        --accent: #6d7cff;
        --accent2: #27d3a7;
        --danger: #ff5a7a;
        --warning: #ffcc66;

        --radius: 22px;
        --radiusSm: 14px;

        --tap: 52px;
        --maxW: 520px;

        --safeT: env(safe-area-inset-top);
        --safeB: env(safe-area-inset-bottom);
        --safeL: env(safe-area-inset-left);
        --safeR: env(safe-area-inset-right);
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg0: #f5f7ff;
          --bg1: #ffffff;
          --card: #ffffffcc;
          --cardSolid: #ffffff;
          --text: #111426;
          --muted: #5a637a;
          --muted2: #7b849b;
          --stroke: #e6eaf5;
          --stroke2: #d9deef;
          --shadow: 0 14px 40px rgba(16, 18, 36, 0.14);
          --accent: #4454ff;
          --accent2: #16bfa1;
        }
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        color: var(--text);
        font-family:
          -apple-system, BlinkMacSystemFont,
          "SF Pro Display", "SF Pro Text",
          system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        text-rendering: optimizeLegibility;
        background:
          radial-gradient(900px 560px at 10% 10%, rgba(109,124,255,.35), transparent 55%),
          radial-gradient(760px 520px at 90% 20%, rgba(39,211,167,.22), transparent 55%),
          radial-gradient(760px 520px at 50% 110%, rgba(109,124,255,.18), transparent 60%),
          linear-gradient(180deg, var(--bg0), var(--bg1));
        overflow-x: hidden;
      }

      .app {
        min-height: 100%;
        padding:
          calc(16px + var(--safeT))
          calc(16px + var(--safeR))
          calc(18px + var(--safeB))
          calc(16px + var(--safeL));
        display: flex;
        justify-content: center;
        align-items: stretch;
      }

      .shell {
        width: 100%;
        max-width: var(--maxW);
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 4px 2px;
      }

      .navBtn {
        height: 44px;
        min-width: 44px;
        padding: 0 12px;
        border-radius: 999px;
        border: 1px solid var(--stroke);
        background: color-mix(in srgb, var(--cardSolid) 55%, transparent);
        color: var(--text);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        transition: transform .08s ease, background .18s ease, border-color .18s ease;
      }
      .navBtn:active { transform: scale(.985); }
      .navBtn[disabled] { opacity: .45; cursor: not-allowed; }
      .navBtn .icon { width: 18px; height: 18px; display: inline-block; }

      .brand { display:flex; align-items:center; gap:10px; min-width: 0; }
      .mark {
        width: 34px; height: 34px;
        border-radius: 12px;
        background:
          radial-gradient(14px 14px at 35% 35%, rgba(255,255,255,.55), transparent 60%),
          linear-gradient(135deg, var(--accent), var(--accent2));
        box-shadow: 0 10px 26px rgba(109, 124, 255, 0.25);
      }
      .brandText { display:flex; flex-direction:column; min-width:0; }
      .brandText b {
        font-size: 14px; letter-spacing:.2px;
        white-space: nowrap; overflow:hidden; text-overflow:ellipsis;
      }
      .brandText span {
        font-size: 12px; color: var(--muted2);
        white-space: nowrap; overflow:hidden; text-overflow:ellipsis;
      }

      .progressWrap { width: 100%; padding: 10px 4px 0; }
      .progressRow {
        display:flex; align-items:center; justify-content:space-between;
        gap: 10px; margin-bottom: 8px;
        color: var(--muted2); font-size: 12px;
      }
      .bar {
        height: 8px; border-radius: 999px;
        background: color-mix(in srgb, var(--stroke) 70%, transparent);
        overflow: hidden;
        border: 1px solid color-mix(in srgb, var(--stroke2) 75%, transparent);
      }
      .bar > i {
        display:block; height:100%; width:0%;
        border-radius: 999px;
        background: linear-gradient(90deg, var(--accent), var(--accent2));
        transition: width .32s cubic-bezier(.2,.8,.2,1);
      }

      .card {
        position: relative;
        border-radius: var(--radius);
        background: var(--card);
        backdrop-filter: blur(14px);
        -webkit-backdrop-filter: blur(14px);
        border: 1px solid color-mix(in srgb, var(--stroke) 70%, transparent);
        box-shadow: var(--shadow);
        padding: 18px;
        overflow: hidden;
      }
      .card::before {
        content: "";
        position: absolute;
        inset: -2px;
        pointer-events: none;
        background:
          radial-gradient(280px 160px at 20% 0%, rgba(109,124,255,.16), transparent 55%),
          radial-gradient(260px 180px at 90% 20%, rgba(39,211,167,.12), transparent 55%);
        opacity: .9;
      }
      .cardInner { position: relative; }

      h1 { margin: 2px 0 6px; font-size: 24px; line-height: 1.2; letter-spacing: -0.2px; }
      p.desc { margin: 0 0 14px; color: var(--muted); font-size: 14px; line-height: 1.45; }

      .fields { display:flex; flex-direction:column; gap:12px; margin-top:8px; }
      .field { display:flex; flex-direction:column; gap:8px; }
      .labelRow { display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
      label { font-size: 13px; color: color-mix(in srgb, var(--text) 92%, var(--muted)); letter-spacing:.2px; }
      .req { font-size: 12px; color: var(--muted2); }

      .control {
        display:flex; align-items:center; gap:10px;
        background: color-mix(in srgb, var(--cardSolid) 78%, transparent);
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
        border-radius: var(--radiusSm);
        padding: 10px 12px;
        min-height: var(--tap);
      }

      input, select, button { font: inherit; color: inherit; }
      input[type="number"], input[type="text"], input[type="date"] {
        appearance: none; -webkit-appearance:none;
        border: 0; outline: none; background: transparent;
        width: 100%; font-size: 16px;
      }
      input[type="date"] { min-height: 22px; }

      select {
        border: 0; outline: none;
        background: transparent; color: var(--text);
        font-size: 14px;
        padding: 6px 10px;
        border-radius: 12px;
        border: 1px solid color-mix(in srgb, var(--stroke2) 78%, transparent);
        background: color-mix(in srgb, var(--cardSolid) 86%, transparent);
        min-width: 84px;
      }

      .hint { font-size: 12px; color: var(--muted2); margin-top: -2px; }

      .error {
        display:none;
        font-size: 12px;
        color: color-mix(in srgb, var(--danger) 90%, var(--text));
        margin-top: 2px;
      }
      .field.invalid .control {
        border-color: color-mix(in srgb, var(--danger) 70%, var(--stroke2));
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--danger) 20%, transparent);
      }
      .field.invalid .error { display:block; }

      .options { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
      .opt {
        text-align:left;
        width:100%;
        min-height: var(--tap);
        padding: 14px 14px;
        border-radius: 18px;
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
        background: color-mix(in srgb, var(--cardSolid) 78%, transparent);
        cursor:pointer;
        -webkit-tap-highlight-color: transparent;
        display:flex; align-items:center; justify-content:space-between; gap:12px;
        transition: transform .08s ease, border-color .18s ease, background .18s ease;
      }
      .opt:active { transform: scale(.99); }
      .opt .sub { font-size: 12px; color: var(--muted2); margin-top: 2px; }
      .opt strong { display:block; font-size: 15px; }

      .pill {
        width: 26px; height: 26px;
        border-radius: 999px;
        border: 1px solid color-mix(in srgb, var(--stroke2) 80%, transparent);
        display:grid; place-items:center;
        flex: 0 0 auto;
        background: transparent;
      }
      .pill i {
        width: 14px; height: 14px;
        border-radius: 6px;
        background: transparent;
        transition: background .18s ease, transform .18s ease;
        transform: scale(.85);
      }
      .opt.selected {
        border-color: color-mix(in srgb, var(--accent) 70%, var(--stroke2));
        background: color-mix(in srgb, var(--accent) 12%, var(--cardSolid));
      }
      .opt.selected .pill {
        border-color: color-mix(in srgb, var(--accent) 70%, var(--stroke2));
        background: color-mix(in srgb, var(--accent) 18%, transparent);
      }
      .opt.selected .pill i {
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        transform: scale(1);
      }

      .sliderWrap { margin-top: 8px; display:flex; flex-direction:column; gap:10px; }
      .sliderHead { display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
      .valueBubble { font-weight: 700; font-size: 18px; letter-spacing: -0.2px; }
      .unit { font-size: 12px; color: var(--muted2); margin-left: 6px; font-weight: 600; }

      input[type="range"] {
        width: 100%;
        height: 34px;
        background: transparent;
        padding: 0; margin: 0;
        -webkit-tap-highlight-color: transparent;
      }
      input[type="range"]::-webkit-slider-runnable-track{
        height: 8px;
        border-radius: 999px;
        background: color-mix(in srgb, var(--stroke) 70%, transparent);
        border: 1px solid color-mix(in srgb, var(--stroke2) 72%, transparent);
      }
      input[type="range"]::-webkit-slider-thumb{
        -webkit-appearance:none;
        width: 26px; height: 26px; margin-top: -10px;
        border-radius: 999px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border: 3px solid color-mix(in srgb, var(--cardSolid) 90%, transparent);
        box-shadow: 0 10px 26px rgba(0,0,0,.25);
      }
      input[type="range"]::-moz-range-track{
        height: 8px; border-radius: 999px;
        background: color-mix(in srgb, var(--stroke) 70%, transparent);
        border: 1px solid color-mix(in srgb, var(--stroke2) 72%, transparent);
      }
      input[type="range"]::-moz-range-thumb{
        width: 26px; height: 26px;
        border-radius: 999px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border: 3px solid color-mix(in srgb, var(--cardSolid) 90%, transparent);
        box-shadow: 0 10px 26px rgba(0,0,0,.25);
      }

      .footer { display:flex; gap:10px; margin-top:14px; }

      .btn {
        flex:1;
        min-height: var(--tap);
        border-radius: 18px;
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
        background: color-mix(in srgb, var(--cardSolid) 78%, transparent);
        cursor:pointer;
        -webkit-tap-highlight-color: transparent;
        user-select:none;
        transition: transform .08s ease, background .18s ease, border-color .18s ease, opacity .18s ease;
        font-weight: 700;
        letter-spacing: .2px;
      }
      .btn:active { transform: scale(.99); }
      .btn.primary {
        border: none;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        box-shadow: 0 16px 38px rgba(109, 124, 255, 0.2);
        color: #0b0c10;
      }
      .btn.primary:disabled { opacity: .55; cursor:not-allowed; box-shadow:none; }
      .btn.ghost {
        background: transparent;
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
        color: var(--text);
      }

      .hero {
        margin: 12px 0 10px;
        border-radius: 22px;
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
        background:
          radial-gradient(260px 120px at 20% 40%, rgba(109,124,255,.24), transparent 55%),
          radial-gradient(260px 120px at 80% 40%, rgba(39,211,167,.20), transparent 55%),
          linear-gradient(180deg, color-mix(in srgb, var(--cardSolid) 85%, transparent), transparent);
        height: 120px;
        position: relative;
        overflow: hidden;
      }
      .hero::after {
        content: "";
        position: absolute;
        inset: 18px;
        border-radius: 18px;
        border: 1px dashed color-mix(in srgb, var(--stroke2) 70%, transparent);
        opacity: .7;
      }
      .heroBadge {
        position: absolute;
        left: 14px; top: 14px;
        padding: 8px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        color: color-mix(in srgb, var(--text) 92%, var(--muted));
        background: color-mix(in srgb, var(--cardSolid) 70%, transparent);
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
      }

      .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .srOnly { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

      .fadeIn { animation: fadeIn .22s ease both; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }

      /* Goals Generation Styles */
      .goalsGenWrap {
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        min-height: 320px;
        text-align:center;
        gap: 24px;
      }

      .loadingCircles { position:relative; width:140px; height:140px; }
      .loadingCircles .ring { position:absolute; inset:0; border-radius:50%; border: 3px solid transparent; }
      .loadingCircles .ring1 { border-top-color: var(--accent); border-right-color: var(--accent); animation: spin 1.2s linear infinite; }
      .loadingCircles .ring2 { inset: 12px; border-bottom-color: var(--accent2); border-left-color: var(--accent2); animation: spin 1.6s linear infinite reverse; }
      .loadingCircles .ring3 { inset: 24px; border-top-color: var(--accent); animation: spin 2s linear infinite; }
      .loadingCircles .centerIcon { position:absolute; inset:36px; display:grid; place-items:center; font-size: 32px; animation: pulse 1.5s ease-in-out infinite; }
      @keyframes spin { to { transform: rotate(360deg);} }
      @keyframes pulse { 0%,100% { transform: scale(1); opacity:1;} 50% { transform: scale(1.1); opacity:.8;} }

      .loadingStatus { font-size: 14px; color: var(--muted); animation: fadeIn .3s ease; }

      .successCheck {
        width: 80px; height: 80px; border-radius: 50%;
        background: linear-gradient(135deg, rgba(39,211,167,.2), rgba(39,211,167,.1));
        display:grid; place-items:center;
        font-size: 36px;
        animation: scaleIn .4s cubic-bezier(.2,.8,.2,1.2);
      }
      @keyframes scaleIn { from { transform: scale(0); opacity:0;} to { transform: scale(1); opacity:1;} }

      .goalsCards { display:flex; flex-direction:column; gap:12px; width:100%; margin-top:8px; }

      .goalCard {
        display:flex;
        align-items:center;
        gap: 14px;
        padding: 16px;
        border-radius: 16px;
        background: color-mix(in srgb, var(--cardSolid) 85%, transparent);
        border: 1px solid color-mix(in srgb, var(--stroke2) 70%, transparent);
        animation: slideUp .35s ease both;
      }
      .goalCard:nth-child(1){ animation-delay: .05s; }
      .goalCard:nth-child(2){ animation-delay: .10s; }
      .goalCard:nth-child(3){ animation-delay: .15s; }
      .goalCard:nth-child(4){ animation-delay: .20s; }
      @keyframes slideUp { from { opacity:0; transform: translateY(12px);} to { opacity:1; transform: translateY(0);} }

      .goalIcon {
        width: 44px; height: 44px;
        border-radius: 12px;
        display:grid; place-items:center;
        font-size: 22px;
        flex: 0 0 auto;
      }
      .goalIcon.calories { background: linear-gradient(135deg, rgba(255,140,60,.25), rgba(255,90,40,.15)); }
      .goalIcon.protein { background: linear-gradient(135deg, rgba(255,90,122,.25), rgba(255,60,90,.15)); }
      .goalIcon.carbs { background: linear-gradient(135deg, rgba(39,211,167,.25), rgba(20,180,140,.15)); }
      .goalIcon.fat { background: linear-gradient(135deg, rgba(255,204,102,.25), rgba(255,180,60,.15)); }

      .goalInfo { flex: 1; text-align:left; }
      .goalInfo .label { font-size: 12px; color: var(--muted2); margin-bottom: 2px; }
      .goalInfo .value { font-size: 20px; font-weight: 700; letter-spacing: -0.2px; }
      .goalInfo .value .unit { font-size: 13px; font-weight: 600; color: var(--muted); margin-left: 4px; }

      .macrosRow { display:flex; gap:10px; }
      .macrosRow .goalCard { flex:1; flex-direction:column; text-align:center; padding: 14px 10px; }
      .macrosRow .goalIcon { width: 38px; height: 38px; font-size: 18px; }
      .macrosRow .goalInfo { text-align:center; }
      .macrosRow .goalInfo .value { font-size: 18px; }

      /* Activity level question */
      .activityOpts .opt .sub { max-width: 220px; }

      /* Gender selection */
      .genderOpts { display:flex; gap:12px; }
      .genderOpts .opt { flex:1; flex-direction:column; text-align:center; padding: 20px 14px; }
      .genderOpts .opt .genderIcon { font-size: 32px; margin-bottom: 8px; }

      /* Hidden state for topbar during generation */
      .topbar.hidden, .progressWrap.hidden {
        opacity: 0;
        pointer-events:none;
        transition: opacity .25s ease;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="shell">
        <div class="topbar" id="topbar">
          <button class="navBtn" id="backBtn" type="button" aria-label="Go back">
            <span class="icon" aria-hidden="true">‚Üê</span>
            <span style="font-weight:700;font-size:14px;">Back</span>
          </button>

          <div class="brand" aria-label="Onboarding">
            <div class="mark" aria-hidden="true"></div>
            <div class="brandText">
              <b>Personal plan setup</b>
              <span id="stepMeta">Step</span>
            </div>
          </div>

          <button class="navBtn" id="skipBtn" type="button">
            <span style="font-weight:700;font-size:14px;">Skip</span>
          </button>
        </div>

        <div class="progressWrap" id="progressWrap" aria-hidden="true">
          <div class="progressRow">
            <span id="progressText">0%</span>
            <span id="progressSteps">0 / 0</span>
          </div>
          <div class="bar"><i id="progressFill"></i></div>
        </div>

        <div class="card" role="region" aria-live="polite" aria-atomic="true">
          <div class="cardInner" id="content"></div>
        </div>

        <div class="footer" id="footer"></div>
      </div>
    </div>

    <script>
      // ---- Data (your onboarding steps) ----
      const STEPS = [
        {
          id: "gender",
          type: "question",
          title: "What's your biological sex?",
          description: "This helps us calculate your metabolism accurately.",
          input: { type: "gender_select", options: ["Male", "Female"] },
          next: "height_weight"
        },
        {
          id: "height_weight",
          type: "form",
          title: "Height & weight",
          description: "This will be used to calibrate your plan.",
          fields: [
            { id: "height", label: "Height", required: true, input: { type: "number", placeholder: "170", unitOptions: ["cm","ft"], defaultUnit: "cm" } },
            { id: "weight", label: "Weight", required: true, input: { type: "number", placeholder: "70", unitOptions: ["kg","lb"], defaultUnit: "kg" } }
          ],
          next: "birthdate"
        },
        {
          id: "birthdate",
          type: "form",
          title: "When were you born?",
          description: "Your age affects your daily calorie needs.",
          fields: [
            { id: "birthdate", label: "Birthdate", required: true, input: { type: "date" } }
          ],
          next: "activity_level"
        },
        {
          id: "activity_level",
          type: "question",
          title: "How active are you?",
          description: "Be honest ‚Äî this significantly affects your calorie target.",
          input: {
            type: "single_select",
            options: [
              { value: "sedentary", label: "Sedentary", sub: "Little to no exercise, desk job" },
              { value: "lightly_active", label: "Lightly Active", sub: "Light exercise 1-3 days/week" },
              { value: "moderately_active", label: "Moderately Active", sub: "Moderate exercise 3-5 days/week" },
              { value: "very_active", label: "Very Active", sub: "Hard exercise 6-7 days/week" },
              { value: "extra_active", label: "Extra Active", sub: "Very hard exercise, physical job" }
            ]
          },
          next: "goal"
        },
        {
          id: "goal",
          type: "question",
          title: "What is your goal?",
          description: "This helps us generate a plan for your calorie intake.",
          input: {
            type: "single_select",
            options: [
              { value: "lose_weight", label: "Lose weight", sub: "Reduce calories gradually" },
              { value: "maintain", label: "Maintain", sub: "Keep a steady intake" },
              { value: "gain_weight", label: "Gain weight", sub: "Support lean gain" }
            ]
          },
          next: "desired_weight"
        },
        {
          id: "desired_weight",
          type: "question",
          title: "What is your desired weight?",
          input: { type: "slider", min: 40, max: 200, step: 0.5, unit: "kg" },
          next: "goal_speed"
        },
        {
          id: "goal_speed",
          type: "question",
          title: "How fast do you want to reach your goal?",
          description: "Weight change per week. Slower is healthier and more sustainable.",
          input: { type: "slider", min: 0.1, max: 1.0, step: 0.1, unit: "kg/week", default: 0.5 },
          next: "coach"
        },
        {
          id: "coach",
          type: "question",
          title: "Do you work with a coach or nutritionist?",
          input: {
            type: "single_select",
            options: [
              { value: "yes", label: "Yes", sub: "We'll align with your guidance" },
              { value: "no", label: "No", sub: "We'll guide you step-by-step" }
            ]
          },
          next: "notifications"
        },
        {
          id: "notifications",
          type: "info",
          title: "Stay on track",
          description: "You can enable notifications later in settings to get reminders for meals and weight tracking.",
          next: "referral"
        },
        {
          id: "referral",
          type: "question",
          title: "Enter referral code (optional)",
          description: "You can skip this step.",
          optional: true,
          input: { type: "text", placeholder: "Referral code" },
          next: "generating"
        },
        {
          id: "generating",
          type: "goals_generation",
          title: "Generating your plan",
          next: null
        }
      ];

      // ---- State ----
      const byId = new Map(STEPS.map(s => [s.id, s]));
      const order = STEPS.map(s => s.id);
      const state = {
        currentId: STEPS[0].id,
        stack: [],
        answers: {},
        generatedGoals: null
      };

      // ---- DOM ----
      const content = document.getElementById("content");
      const footer = document.getElementById("footer");
      const backBtn = document.getElementById("backBtn");
      const skipBtn = document.getElementById("skipBtn");
      const topbar = document.getElementById("topbar");
      const progressWrap = document.getElementById("progressWrap");

      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const progressSteps = document.getElementById("progressSteps");
      const stepMeta = document.getElementById("stepMeta");

      // ---- Native bridge helper (iOS WKWebView) ----
      function postToNative(type, payload) {
        try {
          if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.onboarding) {
            window.webkit.messageHandlers.onboarding.postMessage({ type, payload });
            return true;
          }
        } catch (_) {}
        window.dispatchEvent(new CustomEvent("onboarding", { detail: { type, payload } }));
        return false;
      }

      // ---- Utilities ----
      function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }
      function fmtNumber(n, step) {
        const decimals = (String(step).split(".")[1] || "").length;
        return Number(n).toFixed(decimals);
      }

      function toCm(height, unit) {
        const v = Number(height);
        if (!Number.isFinite(v)) return null;
        return unit === "ft" ? v * 30.48 : v;
      }
      function toKg(weight, unit) {
        const v = Number(weight);
        if (!Number.isFinite(v)) return null;
        return unit === "lb" ? v * 0.453592 : v;
      }

      function calculateAge(birthdate) {
        const birth = new Date(birthdate);
        const today = new Date();
        let age = today.getFullYear() - birth.getFullYear();
        const m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age;
      }

      // ---- Goals Calculation (Mifflin-St Jeor) ----
      function calculateGoals() {
        const hw = state.answers["height_weight"] || {};
        const heightVal = hw.height ?? 170;
        const heightUnit = hw["height__unit"] || "cm";
        const weightVal = hw.weight ?? 70;
        const weightUnit = hw["weight__unit"] || "kg";

        const heightCm = toCm(heightVal, heightUnit) || 170;
        const weightKg = toKg(weightVal, weightUnit) || 70;

        const birthdateData = state.answers["birthdate"] || {};
        const birthdate = birthdateData.birthdate;
        const age = birthdate ? calculateAge(birthdate) : 30;

        const genderData = state.answers["gender"] || {};
        const gender = (genderData.value || "male").toLowerCase();

        let bmr;
        if (gender === "female") {
          bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
        } else {
          bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
        }

        const activityData = state.answers["activity_level"] || {};
        const activityLevel = activityData.value || "moderately_active";
        const activityMultipliers = {
          sedentary: 1.2,
          lightly_active: 1.375,
          moderately_active: 1.55,
          very_active: 1.725,
          extra_active: 1.9
        };
        const tdee = bmr * (activityMultipliers[activityLevel] || 1.55);

        const goalData = state.answers["goal"] || {};
        const goal = goalData.value || "maintain";
        const goalSpeedData = state.answers["goal_speed"] || {};
        const goalSpeed = goalSpeedData.value || 0.5;

        const weeklyCalorieChange = goalSpeed * 7700;
        const dailyCalorieChange = weeklyCalorieChange / 7;

        let targetCalories = tdee;
        if (goal === "lose_weight") targetCalories = tdee - dailyCalorieChange;
        else if (goal === "gain_weight") targetCalories = tdee + dailyCalorieChange;

        targetCalories = Math.round(clamp(targetCalories, 1200, 4500));

        let proteinMultiplier = 1.0;
        if (goal === "gain_weight") proteinMultiplier = 1.15;
        if (goal === "lose_weight") proteinMultiplier = 1.1;
        if (activityLevel === "very_active" || activityLevel === "extra_active") proteinMultiplier *= 1.05;

        const proteinCalories = targetCalories * 0.30;
        const carbsCalories = targetCalories * 0.40;
        const fatCalories = targetCalories * 0.30;

        const proteinG = Math.round((proteinCalories / 4.0) * proteinMultiplier);
        const carbsG = Math.round(carbsCalories / 4.0);
        const fatG = Math.round(fatCalories / 9.0);

        return {
          calories: targetCalories,
          proteinG,
          carbsG,
          fatG,
          bmr: Math.round(bmr),
          tdee: Math.round(tdee)
        };
      }

      // ---- Rendering ----
      function render() {
        const step = byId.get(state.currentId);
        if (!step) return;

        const isGenerating = step.type === "goals_generation";

        topbar.classList.toggle("hidden", isGenerating);
        progressWrap.classList.toggle("hidden", isGenerating);

        const idx = order.indexOf(step.id);
        const total = order.length;
        const pct = Math.round((idx / (total - 1)) * 100);

        progressFill.style.width = `${clamp(pct, 0, 100)}%`;
        progressText.textContent = `${clamp(pct, 0, 100)}%`;
        progressSteps.textContent = `${idx + 1} / ${total}`;
        stepMeta.textContent = `Step ${idx + 1} of ${total}`;

        backBtn.disabled = state.stack.length === 0;
        skipBtn.style.visibility = step.optional ? "visible" : "hidden";

        content.innerHTML = "";
        footer.innerHTML = "";

        const wrap = document.createElement("div");
        wrap.className = "fadeIn";

        if (step.type !== "goals_generation") {
          const h1 = document.createElement("h1");
          h1.textContent = step.title;
          wrap.appendChild(h1);

          if (step.description) {
            const p = document.createElement("p");
            p.className = "desc";
            p.textContent = step.description;
            wrap.appendChild(p);
          }
        }

        if (step.type === "form") {
          wrap.appendChild(renderForm(step));
          renderFooterButtons(step, { showPrimary: true });
        } else if (step.type === "question") {
          wrap.appendChild(renderQuestion(step));
          renderFooterButtons(step, { showPrimary: true });
        } else if (step.type === "info") {
          wrap.appendChild(renderInfo(step));
          renderFooterButtons(step, { showPrimary: true, primaryTitle: "Continue" });
        } else if (step.type === "goals_generation") {
          wrap.appendChild(renderGoalsGeneration(step));
        } else {
          const p = document.createElement("p");
          p.className = "desc";
          p.textContent = "Unsupported step type.";
          wrap.appendChild(p);
          renderFooterButtons(step, { showPrimary: true });
        }

        content.appendChild(wrap);

        setTimeout(() => {
          const first = content.querySelector("input, button.opt");
          if (first && step.type === "form") first.focus({ preventScroll: true });
        }, 80);

        updatePrimaryEnabled(step);
      }

      function renderForm(step) {
        const fieldsWrap = document.createElement("div");
        fieldsWrap.className = "fields";

        const saved = state.answers[step.id] || {};

        step.fields.forEach(field => {
          const fieldEl = document.createElement("div");
          fieldEl.className = "field";
          fieldEl.dataset.fieldId = field.id;

          const labelRow = document.createElement("div");
          labelRow.className = "labelRow";

          const label = document.createElement("label");
          label.textContent = field.label;
          label.setAttribute("for", `in_${step.id}_${field.id}`);

          const req = document.createElement("span");
          req.className = "req";
          req.textContent = field.required ? "Required" : "Optional";

          labelRow.appendChild(label);
          labelRow.appendChild(req);

          const control = document.createElement("div");
          control.className = "control";

          const input = document.createElement("input");
          input.id = `in_${step.id}_${field.id}`;
          input.name = field.id;
          input.type = field.input.type;
          input.placeholder = field.input.placeholder || "";

          if (field.input.type === "number") {
            input.inputMode = "decimal";
            input.autocomplete = "off";
          }
          if (field.input.type === "date") {
            input.autocomplete = "bday";
          }

          input.value = saved[field.id] ?? "";
          control.appendChild(input);

          let unitSelect = null;
          if (field.input.unitOptions && field.input.unitOptions.length) {
            unitSelect = document.createElement("select");
            unitSelect.setAttribute("aria-label", `${field.label} units`);
            const savedUnitKey = `${field.id}__unit`;
            const unitValue = saved[savedUnitKey] || field.input.defaultUnit || field.input.unitOptions[0];

            field.input.unitOptions.forEach(u => {
              const opt = document.createElement("option");
              opt.value = u;
              opt.textContent = u;
              if (u === unitValue) opt.selected = true;
              unitSelect.appendChild(opt);
            });
            control.appendChild(unitSelect);
          }

          const error = document.createElement("div");
          error.className = "error";
          error.textContent = `Please enter your ${field.label.toLowerCase()}.`;

          const onChange = () => {
            const obj = state.answers[step.id] || {};
            obj[field.id] = input.value;
            if (unitSelect) obj[`${field.id}__unit`] = unitSelect.value;
            state.answers[step.id] = obj;
            validateStep(step, { soft: true });
            updatePrimaryEnabled(step);
          };

          input.addEventListener("input", onChange);
          input.addEventListener("change", onChange);
          if (unitSelect) unitSelect.addEventListener("change", onChange);

          fieldEl.appendChild(labelRow);
          fieldEl.appendChild(control);

          if (field.id === "height" && unitSelect) {
            const hint = document.createElement("div");
            hint.className = "hint";
            hint.textContent = "Tip: use cm for best accuracy.";
            fieldEl.appendChild(hint);
          }
          if (field.id === "weight" && unitSelect) {
            const hint = document.createElement("div");
            hint.className = "hint";
            hint.textContent = "You can change units anytime.";
            fieldEl.appendChild(hint);
          }

          fieldEl.appendChild(error);
          fieldsWrap.appendChild(fieldEl);
        });

        return fieldsWrap;
      }

      function renderQuestion(step) {
        const saved = state.answers[step.id] || {};

        if (step.input.type === "gender_select") {
          const options = document.createElement("div");
          options.className = "options genderOpts";

          step.input.options.forEach(optText => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "opt";
            btn.setAttribute("role", "radio");
            btn.setAttribute("aria-checked", "false");

            const icon = document.createElement("div");
            icon.className = "genderIcon";
            icon.textContent = optText === "Male" ? "üë®" : "üë©";

            const strong = document.createElement("strong");
            strong.textContent = optText;

            const right = document.createElement("div");
            right.className = "pill";
            const dot = document.createElement("i");
            right.appendChild(dot);

            btn.appendChild(icon);
            btn.appendChild(strong);
            btn.appendChild(right);

            const isSelected = saved.value === optText.toLowerCase();
            if (isSelected) {
              btn.classList.add("selected");
              btn.setAttribute("aria-checked", "true");
            }

            btn.addEventListener("click", () => {
              state.answers[step.id] = { value: optText.toLowerCase() };
              [...options.querySelectorAll(".opt")].forEach(el => {
                el.classList.remove("selected");
                el.setAttribute("aria-checked", "false");
              });
              btn.classList.add("selected");
              btn.setAttribute("aria-checked", "true");
              updatePrimaryEnabled(step);
              setTimeout(() => goNext(), 160);
            });

            options.appendChild(btn);
          });

          options.setAttribute("role", "radiogroup");
          options.setAttribute("aria-label", step.title);
          return options;
        }

        if (step.input.type === "single_select") {
          const options = document.createElement("div");
          options.className = "options" + (step.id === "activity_level" ? " activityOpts" : "");

          const opts = step.input.options;
          opts.forEach(opt => {
            const isObject = typeof opt === "object";
            const optValue = isObject ? opt.value : opt;
            const optLabel = isObject ? opt.label : opt;
            const optSub = isObject ? opt.sub : null;

            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "opt";
            btn.setAttribute("role", "radio");
            btn.setAttribute("aria-checked", "false");

            const left = document.createElement("div");
            const strong = document.createElement("strong");
            strong.textContent = optLabel;
            left.appendChild(strong);

            if (optSub) {
              const sub = document.createElement("div");
              sub.className = "sub";
              sub.textContent = optSub;
              left.appendChild(sub);
            }

            const right = document.createElement("div");
            right.className = "pill";
            const dot = document.createElement("i");
            right.appendChild(dot);

            btn.appendChild(left);
            btn.appendChild(right);

            const isSelected = saved.value === optValue;
            if (isSelected) {
              btn.classList.add("selected");
              btn.setAttribute("aria-checked", "true");
            }

            btn.addEventListener("click", () => {
              state.answers[step.id] = { value: optValue };
              [...options.querySelectorAll(".opt")].forEach(el => {
                el.classList.remove("selected");
                el.setAttribute("aria-checked", "false");
              });
              btn.classList.add("selected");
              btn.setAttribute("aria-checked", "true");
              updatePrimaryEnabled(step);
              setTimeout(() => goNext(), 160);
            });

            options.appendChild(btn);
          });

          options.setAttribute("role", "radiogroup");
          options.setAttribute("aria-label", step.title);
          return options;
        }

        if (step.input.type === "slider") {
          const savedVal = (saved.value != null) ? Number(saved.value) : null;
          const defaultVal = step.input.default ?? (step.input.min + ((step.input.max - step.input.min) * 0.5));
          let initial = (savedVal != null && Number.isFinite(savedVal)) ? savedVal : defaultVal;

          if (step.id === "desired_weight") {
            const hw = state.answers["height_weight"] || {};
            const weightVal = hw.weight;
            const weightUnit = hw["weight__unit"] || "kg";
            if (weightVal) {
              const weightKg = toKg(weightVal, weightUnit);
              if (weightKg) initial = savedVal ?? weightKg;
            }
          }

          const wrap = document.createElement("div");
          wrap.className = "sliderWrap";

          const head = document.createElement("div");
          head.className = "sliderHead";

          const left = document.createElement("div");
          left.style.color = "var(--muted)";
          left.style.fontSize = "13px";
          left.textContent = step.id === "desired_weight" ? "Your target weight" : "Adjust to your preference";

          const right = document.createElement("div");
          const val = document.createElement("span");
          val.className = "valueBubble";
          val.textContent = fmtNumber(initial, step.input.step);

          const unit = document.createElement("span");
          unit.className = "unit";
          unit.textContent = step.input.unit;

          right.appendChild(val);
          right.appendChild(unit);

          head.appendChild(left);
          head.appendChild(right);

          const range = document.createElement("input");
          range.type = "range";
          range.min = step.input.min;
          range.max = step.input.max;
          range.step = step.input.step;
          range.value = initial;

          const hint = document.createElement("div");
          hint.className = "hint";
          hint.textContent = (step.id === "goal_speed")
            ? "Tip: 0.5 kg/week is a healthy, sustainable pace."
            : `Range: ${step.input.min}‚Äì${step.input.max} ${step.input.unit}`;

          range.addEventListener("input", () => {
            val.textContent = fmtNumber(range.value, step.input.step);
            state.answers[step.id] = { value: Number(range.value) };
            updatePrimaryEnabled(step);
          });

          state.answers[step.id] = { value: Number(initial) };

          wrap.appendChild(head);
          wrap.appendChild(range);
          wrap.appendChild(hint);
          return wrap;
        }

        if (step.input.type === "text") {
          const savedText = saved.value ?? "";
          const fieldEl = document.createElement("div");
          fieldEl.className = "field";

          const labelRow = document.createElement("div");
          labelRow.className = "labelRow";

          const label = document.createElement("label");
          label.textContent = "Referral code";
          label.setAttribute("for", `in_${step.id}_ref`);

          const req = document.createElement("span");
          req.className = "req";
          req.textContent = step.optional ? "Optional" : "Required";

          labelRow.appendChild(label);
          labelRow.appendChild(req);

          const control = document.createElement("div");
          control.className = "control";

          const input = document.createElement("input");
          input.id = `in_${step.id}_ref`;
          input.type = "text";
          input.placeholder = step.input.placeholder || "Referral code";
          input.autocapitalize = "characters";
          input.autocomplete = "off";
          input.value = savedText;

          input.addEventListener("input", () => {
            state.answers[step.id] = { value: input.value.trim() };
            updatePrimaryEnabled(step);
          });

          control.appendChild(input);

          const hint = document.createElement("div");
          hint.className = "hint";
          hint.textContent = "If you don't have one, you can skip."; /* FIXED */

          fieldEl.appendChild(labelRow);
          fieldEl.appendChild(control);
          fieldEl.appendChild(hint);

          state.answers[step.id] = { value: savedText };

          return fieldEl;
        }

        const p = document.createElement("p");
        p.className = "desc";
        p.textContent = "Unsupported question input.";
        return p;
      }

      function renderInfo(step) {
        const frag = document.createDocumentFragment();

        const hero = document.createElement("div");
        hero.className = "hero";
        const badge = document.createElement("div");
        badge.className = "heroBadge";
        badge.textContent = "Quick note";
        hero.appendChild(badge);

        frag.appendChild(hero);

        const extra = document.createElement("p");
        extra.className = "desc";
        extra.style.marginTop = "10px";
        extra.textContent = "We'll keep things lightweight ‚Äî only the reminders you want."; /* FIXED */
        frag.appendChild(extra);

        return frag;
      }

      function renderGoalsGeneration(step) {
        const wrap = document.createElement("div");
        wrap.className = "goalsGenWrap";

        const loadingDiv = document.createElement("div");
        loadingDiv.id = "goalsLoading";

        const circles = document.createElement("div");
        circles.className = "loadingCircles";
        circles.innerHTML = `
          <div class="ring ring1"></div>
          <div class="ring ring2"></div>
          <div class="ring ring3"></div>
          <div class="centerIcon">‚ú®</div>
        `;

        const title = document.createElement("h1");
        title.textContent = "Generating your plan";
        title.style.marginTop = "16px";

        const statusEl = document.createElement("div");
        statusEl.className = "loadingStatus";
        statusEl.id = "loadingStatus";
        statusEl.textContent = "Analyzing your profile...";

        loadingDiv.appendChild(circles);
        loadingDiv.appendChild(title);
        loadingDiv.appendChild(statusEl);
        wrap.appendChild(loadingDiv);

        const resultsDiv = document.createElement("div");
        resultsDiv.id = "goalsResults";
        resultsDiv.style.display = "none";
        resultsDiv.style.width = "100%";
        wrap.appendChild(resultsDiv);

        setTimeout(() => startGoalsGeneration(), 100);
        return wrap;
      }

      function startGoalsGeneration() {
        const statusEl = document.getElementById("loadingStatus");
        const messages = [
          "Analyzing your profile...",
          "Calculating your metabolism...",
          "Determining optimal macros...",
          "Personalizing your goals..."
        ];

        let msgIndex = 0;
        const msgInterval = setInterval(() => {
          msgIndex++;
          if (msgIndex < messages.length && statusEl) statusEl.textContent = messages[msgIndex];
        }, 600);

        setTimeout(() => {
          clearInterval(msgInterval);

          const goals = calculateGoals();
          state.generatedGoals = goals;

          const hw = state.answers["height_weight"] || {};
          const heightVal = hw.height ?? 170;
          const heightUnit = hw["height__unit"] || "cm";
          const weightVal = hw.weight ?? 70;
          const weightUnit = hw["weight__unit"] || "kg";

          state.answers._normalized = {
            height_cm: toCm(heightVal, heightUnit),
            weight_kg: toKg(weightVal, weightUnit)
          };

          showGoalsResults(goals);
        }, 2500);
      }

      function showGoalsResults(goals) {
        const loadingEl = document.getElementById("goalsLoading");
        const resultsEl = document.getElementById("goalsResults");

        if (loadingEl) loadingEl.style.display = "none";
        if (resultsEl) {
          resultsEl.style.display = "block";
          resultsEl.innerHTML = `
            <div class="successCheck">‚úì</div>
            <h1 style="margin-top:16px;">Your personalized goals</h1>
            <p class="desc">Based on your profile and preferences</p>

            <div class="goalsCards">
              <div class="goalCard">
                <div class="goalIcon calories">üî•</div>
                <div class="goalInfo">
                  <div class="label">Daily Calories</div>
                  <div class="value">${goals.calories}<span class="unit">kcal</span></div>
                </div>
              </div>

              <div class="macrosRow">
                <div class="goalCard">
                  <div class="goalIcon protein">ü•©</div>
                  <div class="goalInfo">
                    <div class="label">Protein</div>
                    <div class="value">${goals.proteinG}<span class="unit">g</span></div>
                  </div>
                </div>
                <div class="goalCard">
                  <div class="goalIcon carbs">üåæ</div>
                  <div class="goalInfo">
                    <div class="label">Carbs</div>
                    <div class="value">${goals.carbsG}<span class="unit">g</span></div>
                  </div>
                </div>
                <div class="goalCard">
                  <div class="goalIcon fat">ü•ë</div>
                  <div class="goalInfo">
                    <div class="label">Fat</div>
                    <div class="value">${goals.fatG}<span class="unit">g</span></div>
                  </div>
                </div>
              </div>
            </div>
          `;

          renderFooterButtons(byId.get("generating"), { showPrimary: true, primaryTitle: "Get Started" });
        }
      }

      function renderFooterButtons(step, { showPrimary, primaryTitle } = {}) {
        const primary = document.createElement("button");
        primary.className = "btn primary";
        primary.type = "button";

        primary.textContent = primaryTitle || (step.next ? "Continue" : "Finish");
        primary.addEventListener("click", () => {
          if (step.type === "goals_generation") {
            finish();
            return;
          }
          const ok = validateStep(step, { soft: false });
          if (!ok) return;
          goNext();
        });

        let secondary = null;
        if (step.optional) {
          secondary = document.createElement("button");
          secondary.className = "btn ghost";
          secondary.type = "button";
          secondary.textContent = "Skip";
          secondary.addEventListener("click", () => {
            delete state.answers[step.id];
            goNext();
          });
        }

        if (secondary) footer.appendChild(secondary);
        if (showPrimary) footer.appendChild(primary);

        footer.dataset.primaryId = "primary";
        primary.dataset.role = "primary";
      }

      // ---- Validation ----
      function validateStep(step, { soft }) {
        if (step.type !== "form") return true;

        let ok = true;
        const saved = state.answers[step.id] || {};

        step.fields.forEach(field => {
          const fieldEl = content.querySelector(`.field[data-field-id="${field.id}"]`);
          const val = (saved[field.id] ?? "").toString().trim();

          const required = !!field.required;
          const isEmpty = val.length === 0;

          let invalid = false;
          if (required && isEmpty) invalid = true;

          if (!isEmpty && field.input.type === "number") {
            const num = Number(val);
            if (!Number.isFinite(num) || num <= 0) invalid = true;
          }
          if (!isEmpty && field.input.type === "date") {
            const d = new Date(val);
            if (String(d) === "Invalid Date") invalid = true;
          }

          if (invalid) ok = false;

          if (fieldEl) {
            if (!soft) fieldEl.classList.toggle("invalid", invalid);
            else if (!invalid) fieldEl.classList.remove("invalid");
          }
        });

        return ok;
      }

      function updatePrimaryEnabled(step) {
        const primary = footer.querySelector('[data-role="primary"]');
        if (!primary) return;

        let enabled = true;

        if (step.type === "form") {
          enabled = validateStep(step, { soft: true });
        } else if (step.type === "question") {
          const a = state.answers[step.id];
          if (step.input.type === "single_select" || step.input.type === "gender_select") {
            enabled = !!(a && a.value);
          } else if (step.input.type === "slider") {
            enabled = !!(a && a.value != null);
          } else if (step.input.type === "text") {
            enabled = step.optional ? true : !!(a && a.value && a.value.trim().length);
          }
        } else if (step.type === "info") {
          enabled = true;
        } else if (step.type === "goals_generation") {
          enabled = !!state.generatedGoals;
        }

        primary.disabled = !enabled;
      }

      // ---- Navigation ----
      function goTo(stepId) {
        const step = byId.get(stepId);
        if (!step) return;
        state.currentId = stepId;
        render();
        postToNative("step_view", { stepId });
      }

      function goNext() {
        const step = byId.get(state.currentId);
        if (!step) return;

        if (!step.next) {
          finish();
          return;
        }

        state.stack.push(step.id);

        if (step.id === "height_weight") {
          const a = state.answers[step.id] || {};
          const h = a.height, hu = a["height__unit"] || "cm";
          const w = a.weight, wu = a["weight__unit"] || "kg";
          const cm = toCm(h, hu);
          const kg = toKg(w, wu);
          state.answers._normalized = state.answers._normalized || {};
          state.answers._normalized.height_cm = cm;
          state.answers._normalized.weight_kg = kg;
        }

        goTo(step.next);
      }

      function goBack() {
        const prev = state.stack.pop();
        if (!prev) return;
        goTo(prev);
      }

      function finish() {
        const payload = {
          answers: state.answers,
          goals: state.generatedGoals,
          completedAt: new Date().toISOString()
        };

        postToNative("complete", payload);

        content.innerHTML = `
          <div class="fadeIn goalsGenWrap">
            <div class="successCheck">üéâ</div>
            <h1>All set!</h1>
            <p class="desc">Your personalized plan is ready. Let's get started!</p>
          </div>
        `;
        footer.innerHTML = "";
        topbar.classList.add("hidden");
        progressWrap.classList.add("hidden");

        console.log("[Onboarding complete]", payload);
      }

      // ---- Topbar events ----
      backBtn.addEventListener("click", goBack);
      skipBtn.addEventListener("click", () => {
        const step = byId.get(state.currentId);
        if (step && step.optional) {
          delete state.answers[step.id];
          goNext();
        }
      });

      // ---- Init ----
      render();
      postToNative("ready", { firstStepId: state.currentId });

      window.OnboardingWeb = {
        getState: () => JSON.parse(JSON.stringify(state)),
        setAnswers: (answersObj) => { state.answers = answersObj || {}; render(); },
        goTo: (stepId) => goTo(stepId),
        finish: () => finish()
      };
    </script>
  </body>
</html>
